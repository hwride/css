<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Response images with srcset and sizes</title>
	<link rel="stylesheet" type="text/css" href="../common.css">
	<link rel="stylesheet" type="text/css" href="srcset-sizes.css">
</head>
<body>
<h1>Response images with srcset and sizes</h1>
<ul>
	<li><a href="#references">References</a></li>
	<li><a href="#general-notes">General notes</a></li>
	<li><a href="#questions">Questions</a></li>
	<li>
		<a href="#examples">Examples</a>
		<ul>
			<li><a href="#simple-img">Simple image with src</a></li>
			<li><a href="#srcset-pixel-density-descriptor">srcset with pixel density descriptors</a></li>
			<li><a href="#srcset-width-descriptors">srcset with width descriptors</a></li>
			<li><a href="#srcset-and-sizes">srcset and sizes</a></li>
		</ul>
	</li>
	<li><a href="#results">Results</a></li>
</ul>

<h2 id="references">References</h2>
<ul>
	<li>
		<a href="https://jakearchibald.com/2015/anatomy-of-responsive-images/">
			Jake Archibald - The anatomy of responsive images
		</a>
	</li>
	<li><a href="https://caniuse.com/srcset">caniuse - srcset and sizes</a></li>
	<li><a href="https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset">HTML specification</a></li>
</ul>

<h2 id="general-notes">General notes</h2>
<p class="example-description">
	The zoom level can affect device pixel ratio. If you notice the device pixel ratio isn't what you expect check
	if you're zoomed in.
</p>

<h2 id="questions">Questions</h2>
<ul>
	<li>
		How does rounding work for device pixel ratio and width descriptors with srcset?
		Does it round up to the nearest matching image ensure we never have an image too low resolution?
	</li>
	<li>
		Why are the images below different rendered widths when the same image is picked? I.e. sometimes the picked
		image is the 1500x250, but its rendered with is 600x250. This is when no width information is provided on HTML
		attributes or in the CSS, so why is it not the natural image size?
	</li>
</ul>

<h2 id="examples">Examples</h2>
<div id="simple-img" class="example">
	<h3>
		Simple image with <code>src</code> attribute
	</h3>
	<figure>
		<img alt="A test responsive image"
			 src="300x250.png" />
		<figcaption>
			<pre>
&lt;img alt="A test responsive image"
     src="fallback.png" /&gt;
			</pre>
		</figcaption>
	</figure>

	<p class="example-description">
		This is just a standard image with a <code>src</code> attribute. It will load exactly the image specified in
		<code>src</code> and never any other.
	</p>
</div>

<!-- Pixel density descriptor -->
<div id="srcset-pixel-density-descriptor" class="example">
	<h3>
		Image with <code>srcset</code> and display density descriptor.
	</h3>
	<figure>
		<img
			alt="A test responsive image"
			src="fallback.png"
			srcset="
			600x250.png 1x,
			1200x250.png 2x,
			1500x250.png 3x
		" />
		<figcaption>
			<pre>
&lt;img alt="A test responsive image"
     src="fallback.png"
     srcset="600x250.png 1x,
             1200x250.png 2x,
             1500x250.png 3x" /&gt;
			</pre>
		</figcaption>
	</figure>

	<p class="example-description">
		The pixel density descriptor of <code>srcset</code> lets you tell the browser what image should be used
		depending on the device pixel ratio. If there are 1x, 2x or 3x device pixels to CSS pixels then the corresponding
		image will be chosen.
	</p>
	<p class="example-description">
		You can see the device pixel ratio in the information in the bottom right of the screen under <code>devicePixelRatio</code>.
	</p>
	<p class="example-description">
		Note that the actual number width of the device or window does not affect the calculation, only the device pixel
		ratio.
	</p>
</div>

<!-- srcset with pixel widths-->
<div id="srcset-width-descriptors" class="example">
	<h3>
		Image with <code>srcset</code> and pixel widths.
	</h3>
	<figure>
		<img alt="A test responsive image"
			 src="fallback.png"
			 srcset="300x250.png 300w,
									 600x250.png 600w,
									 1200x250.png 1200w,
									 1500x250.png 1500w" />
		<figcaption>
			<pre>
&lt;img alt="A test responsive image"
     src="fallback.png"
     srcset="300x250.png 300w,
             600x250.png 600w,
             1200x250.png 1200w,
             1500x250.png 1500w" /&gt;
			</pre>
		</figcaption>
	</figure>

	<p class="example-description">
		Here <code>srcset</code> is used to define at images at different sizes. The format is:
		<code>&lt;image-url&gt; &lt;width descriptor&gt;</code>. Width descriptor describes the pixel width of the source
		image.
	</p>

	<h3>Without sizes</h3>
	<p class="example-description">
		Some resources online say that when <code>srcset</code> is used without <code>sizes</code>, it is assumed the
		image should fill the entire browser width. But according to the specification it is invalid to use
		<code>srcset</code> with width descriptors without a <code>sizes</code> attribute:
	</p>
	<blockquote cite="https://html.spec.whatwg.org/multipage/embedded-content.html#attr-img-srcset">
		If the <code>srcset</code> attribute is present and has any image candidate strings using a width
		descriptor, the <code>sizes</code> attribute must also be present
	</blockquote>

	<h3>Pixel density</h3>
	<p class="example-description">
		Note that even when using width descriptors with <code>srcset</code>, the browser will try and take pixel density
		into account. It will do this by selecting an image size according to device pixels rather than CSS pixels. You
		can see this value in the info section as <code>devicePixelRatio * outerWidth</code>.
	</p>
</div>

<!-- srcset and sizes-->
<div id="srcset-and-sizes" class="example">
	<h3>
		Image with <code>srcset</code> and <code>sizes</code> attribute
	</h3>

	<figure>
	<!-- src is a fallback for older browsers -->
	<!-- srcset: browser uses first condition that matches -->
	<!-- sizes: it appears the media queries match the document width and not the window width, at least on Chrome -->
		<img alt="A test responsive image"
			 src="fallback.png"
			 srcset="300x250.png 300w,
									 600x250.png 600w,
									 1200x250.png 1200w,
									 1500x250.png 1500w"
			 sizes="(min-width: 1500px) 1500px,
									(min-width: 1200px) 1200px,
									(min-width: 600px) 600px,
									(min-width: 300px) 300px,
									300px" />
		<figcaption>
			<pre>
&lt;img alt="A test responsive image"
     src="fallback.png"
     srcset="<span class="srcset-src">300x250.png</span> <span class="srcset-width-descriptor">300w</span>,
             <span class="srcset-src">600x250.png</span> <span class="srcset-width-descriptor">600w</span>,
             <span class="srcset-src">1200x250.png</span> <span class="srcset-width-descriptor">1200w</span>,
             <span class="srcset-src">1500x250.png</span> <span class="srcset-width-descriptor">1500w</span>"
     sizes="<span class="sizes-media-condition">(min-width: 1500px)</span> <span class="sizes-source-size-value">1500px</span>,
            <span class="sizes-media-condition">(min-width: 1200px)</span> <span class="sizes-source-size-value">1200px</span>,
            <span class="sizes-media-condition">(min-width: 600px)</span> <span class="sizes-source-size-value">600px</span>,
            <span class="sizes-media-condition">(min-width: 300px)</span> <span class="sizes-source-size-value">300px</span>,
            <span class="sizes-source-size-value">300px</span>" /&gt;
			</pre>
		</figcaption>
	</figure>

	<p class="example-description">
		When using the <code>sizes</code> attributes you are able to specify conditions about when each image should be
		used.
	</p>
	<h4>Match order</h4>
	<p class="example-description">
		The statements in <code>sizes</code> are read first to last, and the first matching one will one. This means order
		is important depending on how you write your media conditions.
	</p>
	<h5>Fallback</h5>
	<p class="example-description">
		The final entry in <code>sizes</code> doesn't have a condition, it's just a source size value. It is a fallback
		and is used if none of the media conditions match.
	</p>
	<h4>CSS pixels, device pixels and pixel density</h4>
	<p class="example-description">
		An important thing to note is the <code>sizes</code> media conditions use CSS pixels, but the actual image size
		chosen from <code>srcset</code> will be chosen taking the pixel density of the device into account.
	</p>
	<h4>Worked example</h4>
	<p class="example-description">
		Above is an example image using <code>srcset</code> and <code>sizes</code>. Described here are the steps taken
		by the browser to work out the final image to display, in this example for an iPhone 11.
	</p>
	<ol>
		<li>
			Work out the entry from <code>sizes</code> that matches:
			<ol>
				<li>The width of an iPhone 11 in CSS pixels is 414.</li>
				<li>Going down the <code>sizes</code> list from the top, the first condition to match is
					<code class="sizes-media-condition">min-width: 300px</code>.</li>
				<li>
					This has a source size value (the right-hand size) of
					<code class="sizes-source-size-value">300px</code> which is the desired width
					of the image in CSS pixels.
				</li>
			</ol>
		</li>
		<li>
			Work out that entry from <code>srcset</code> that matches:
			<ol>
				<li>
					First work out what the desired image size in device pixels. We do this by multiplying the source
					size value we just worked out by the device's pixel density, which for iPhone 11 is 2. In this case
					that's:
					<i style="display: block; margin-left: var(--spacing-20)">
						<span class="sizes-source-size-value">300px</span> (CSS pixels) * 2 (pixel density) =
						600px (device pixels)
					</i>
				</li>
				<li>
					The <code>srcset</code> attribute is then consulted to find the closest matching image. In this case
					there is a width descriptor of <code class="srcset-width-descriptor">600w</code> which matches 600px
					exactly. This results in the corresponding <code class="srcset-src">600x250.png</code> image being
					chosen.
				</li>
			</ol>
		</li>
	</ol>
</div>
<div class="info">
	<table>
		<tr>
			<td><code>window.innerWidth</code></td><td><span class="window-inner-width"></span></td>
		</tr>
		<tr>
			<td><code>devicePixelRatio * innerWidth</code></td><td><span class="device-pixels-inner"></span></td>
		</tr>
		<tr>
			<td><code>window.devicePixelRatio</code></td><td><span class="device-pixel-ratio"></span></td>
		</tr>
		<tr>
			<td><code>window.outerWidth</code></td><td><span class="window-outer-width"></span></td>
		</tr>
		<tr>
			<td><code>devicePixelRatio * outerWidth</code></td><td><span class="device-pixels-outer"></span></td>
		</tr>
	</table>
</div>

<!-- Results -->
<div id="results">
	<h2>
		Results
	</h2>
	<p class="example-description">
		Here is a recording of the images that were loaded for various device, browser and window sizes combinations
		for the examples above.
	</p>
	<table class="results-table">
		<thead>
		</thead>
		<tbody>
		</tbody>
	</table>
</div>
	<h3>Notes</h3>
	<ul class="results-notes">
		<li>
			Windows + Chrome appears to change the selected image for the pixel density srcset example when the
			window size changes, even though the pixel density remains the same. This isn't what I'd expect and doesn't
			seem to match the intention of pixel density descriptors.
		</li>
		<li>
			The moto e(7i) power reports a <code>innerWidth</code> larger than <code>outerWidth</code>. This essentially
			appears to be an Android bug on mobile.
		</li>
	</ul>
</body>
<script src="../nav.js"></script>
<script>createNav()</script>
<script src="srcset-sizes-results.js"></script>
<script src="srcset-sizes.js"></script>
</html>
